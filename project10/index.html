<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>미몽이 맞추기</title>
  <style>
    body {
      text-align: center;
      font-family: sans-serif;
      background: linear-gradient(135deg, #f5f5f5, #e0f7fa);
      margin: 0;
      padding: 20px;
    }
    h1 { margin-bottom: 10px; }
    #menu, #game, #result, #preview { display: none; }
    #game-area {
      margin: 20px auto;
      display: inline-block;
      border: 2px solid #333;
      background: white;
      position: relative;
    }
    canvas {
      display: block;
      margin: 0 auto;
      border: 2px solid #333;
      background: white;
    }
    button {
      margin: 10px;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: 0.2s;
      background: #0077cc; 
      color: white;
    }
    button:hover { background: #005fa3; }
    /* 선택 카드 스타일 */
    .char-choice {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-top: 30px;
      flex-wrap: wrap;
    }
    .char-card {
      background: #fff8e1;
      border: 2px solid #ffa726;
      border-radius: 10px;
      padding: 15px;
      width: 200px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .char-card:hover { transform: scale(1.05); }
    .char-card img { max-width: 100%; border-radius: 10px; }
    .char-card button {
      background: orange; border: none; padding: 10px; margin-top: 10px; 
      font-size: 16px; font-weight: bold; color: white; border-radius: 8px; cursor: pointer;
      width: 100%;
    }
    .char-card button:hover { background: #ff7043; }
    #result img {
      margin: 10px;
      border: 2px solid #333;
    }
  </style>
</head>
<body>
  <h1>미몽이 맞추기</h1>

  <!-- 선택 메뉴 -->
  <div id="menu">
    <h2>선택하기</h2>
    <div class="char-choice">
      <div class="char-card">
        <img src="set1/preview.png" alt="미몽이">
        <button onclick="previewSet('set1')">미몽이</button>
      </div>
      <div class="char-card">
        <img src="set2/preview.png" alt="아이미">
        <button onclick="previewSet('set2')">아이미</button>
      </div>
    </div>
  </div>

  <!-- 미리보기 -->
  <div id="preview">
    <h2></h2>
    <img id="previewImg" src="" style="max-width:400px; border:2px solid #333;">
    <br>
    <button onclick="startGame()">게임 시작</button>
    <button onclick="goMenu()">뒤로가기</button>
  </div>

  <!-- 게임 화면 -->
  <div id="game">
    <p id="status">""</p>
    <div id="game-area">
      <canvas id="gameCanvas"></canvas>
    </div>
  </div>

  <!-- 결과 화면 -->
  <div id="result">
    <h2 id="finalText"></h2>
    <div>
      <p>결과</p>
      <canvas id="finalCanvas"></canvas>
      <p>정답 </p>
      <img id="originalResult" src="">
    </div>
    <button onclick="goMenu()">다시 선택하기</button>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const finalCanvas = document.getElementById("finalCanvas");
    const fctx = finalCanvas.getContext("2d");

    const menu = document.getElementById("menu");
    const game = document.getElementById("game");
    const result = document.getElementById("result");
    const preview = document.getElementById("preview");
    const status = document.getElementById("status");
    const finalText = document.getElementById("finalText");
    const previewImg = document.getElementById("previewImg");
    const originalResult = document.getElementById("originalResult");

    const sets = {
      set1: {
        original: "set1/im.png",
        parts: Array.from({ length: 13 }, (_, i) => `set1/p${i+1}.png`)
      },
      set2: {
        original: "set2/im.png",
        parts: Array.from({ length: 10 }, (_, i) => `set2/p${i+1}.png`)
      }
    };

    let currentSet = null;
    let parts = [];
    let currentIndex = 0;
    let originalImg = new Image();
    let draggingImg = null;
    let dragging = false;

    // 선택 메뉴 → 미리보기
    function previewSet(setName) {
      currentSet = sets[setName];
      previewImg.src = currentSet.original;
      preview.style.display = "block";
      menu.style.display = "none";
      result.style.display = "none";
      game.style.display = "none";
    }

    function goMenu() {
      game.style.display = "none";
      result.style.display = "none";
      preview.style.display = "none";
      menu.style.display = "block";
    }

    function startGame() {
      parts = currentSet.parts;
      currentIndex = 0;

      preview.style.display = "none";
      game.style.display = "block";

      originalImg = new Image();
      originalImg.src = currentSet.original;
      originalImg.onload = () => {
        canvas.width = originalImg.width;
        canvas.height = originalImg.height;
        finalCanvas.width = originalImg.width;
        finalCanvas.height = originalImg.height;
        status.innerText = "시작!";
        showNextPart();
      };
    }

    function showNextPart() {
      if (currentIndex >= parts.length) {
        finishGame();
        return;
      }
      draggingImg = new Image();
      draggingImg.src = parts[currentIndex];
      draggingImg.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        status.innerText = `${currentIndex + 1}번째 파츠를 배치하세요`;
        dragging = true;
      };
    }

    canvas.addEventListener("mousemove", (e) => {
      if (dragging && draggingImg) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const rect = canvas.getBoundingClientRect();
        let x = e.clientX - rect.left - draggingImg.width / 2;
        let y = e.clientY - rect.top - draggingImg.height / 2;
        ctx.drawImage(draggingImg, x, y);
      }
    });

    canvas.addEventListener("click", (e) => {
      if (dragging && draggingImg) {
        const rect = canvas.getBoundingClientRect();
        let x = e.clientX - rect.left - draggingImg.width / 2;
        let y = e.clientY - rect.top - draggingImg.height / 2;

        // 내가 배치한 최종 캔버스에 그리기
        fctx.drawImage(draggingImg, x, y);

        dragging = false;
        currentIndex++;
        showNextPart();
      }
    });

    function finishGame() {
      game.style.display = "none";
      result.style.display = "block";
      finalText.innerText = "ㅊㅊㅊㅊ";
      originalResult.src = currentSet.original;
    }

    goMenu();
  </script>
</body>
</html>
